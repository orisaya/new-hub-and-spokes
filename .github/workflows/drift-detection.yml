# ============================================================================
# DRIFT DETECTION WORKFLOW
# ============================================================================
# Runs weekly to detect configuration drift in deployed infrastructure
# Creates issues if drift is detected

name: Drift Detection

on:
  schedule:
    # Run every Monday at 8:00 AM UTC
    - cron: '0 8 * * 1'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to check for drift'
        required: true
        type: choice
        options:
          - dev
          - prod
          - both
        default: 'both'

permissions:
  id-token: write
  contents: read
  issues: write

jobs:
  # Detect drift in dev environment
  detect-drift-dev:
    name: Drift Detection - Dev
    if: |
      (github.event_name == 'schedule') ||
      (github.event_name == 'workflow_dispatch' &&
       (github.event.inputs.environment == 'dev' || github.event.inputs.environment == 'both'))
    runs-on: ubuntu-latest
    environment: dev
    outputs:
      drift_detected: ${{ steps.plan.outputs.exitcode }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Terraform Init
        run: |
          terraform init \
            -backend-config=environments/dev/backend.tf \
            -reconfigure
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          ARM_USE_OIDC: true

      - name: Terraform Plan (Drift Detection)
        id: plan
        run: |
          terraform plan \
            -var-file=environments/dev/terraform.tfvars \
            -detailed-exitcode \
            -no-color > /tmp/drift-dev.txt 2>&1 || echo "exitcode=$?" >> $GITHUB_OUTPUT
          cat /tmp/drift-dev.txt
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          ARM_USE_OIDC: true
        continue-on-error: true

      - name: Upload Drift Report
        if: steps.plan.outputs.exitcode == '2'
        uses: actions/upload-artifact@v4
        with:
          name: drift-report-dev
          path: /tmp/drift-dev.txt
          retention-days: 30

      - name: Create Drift Summary
        run: |
          echo "### Drift Detection - Dev Environment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ steps.plan.outputs.exitcode }}" == "0" ]]; then
            echo "‚úÖ **No drift detected**" >> $GITHUB_STEP_SUMMARY
            echo "Infrastructure matches Terraform configuration." >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ steps.plan.outputs.exitcode }}" == "2" ]]; then
            echo "‚ö†Ô∏è **Drift detected!**" >> $GITHUB_STEP_SUMMARY
            echo "Infrastructure has diverged from Terraform configuration." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Action Required:** Review the drift report and take corrective action." >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Error occurred**" >> $GITHUB_STEP_SUMMARY
            echo "Failed to check for drift. Review logs for details." >> $GITHUB_STEP_SUMMARY
          fi

  # Detect drift in prod environment
  detect-drift-prod:
    name: Drift Detection - Prod
    if: |
      (github.event_name == 'schedule') ||
      (github.event_name == 'workflow_dispatch' &&
       (github.event.inputs.environment == 'prod' || github.event.inputs.environment == 'both'))
    runs-on: ubuntu-latest
    environment: prod
    outputs:
      drift_detected: ${{ steps.plan.outputs.exitcode }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Terraform Init
        run: |
          terraform init \
            -backend-config=environments/prod/backend.tf \
            -reconfigure
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          ARM_USE_OIDC: true

      - name: Terraform Plan (Drift Detection)
        id: plan
        run: |
          terraform plan \
            -var-file=environments/prod/terraform.tfvars \
            -detailed-exitcode \
            -no-color > /tmp/drift-prod.txt 2>&1 || echo "exitcode=$?" >> $GITHUB_OUTPUT
          cat /tmp/drift-prod.txt
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          ARM_USE_OIDC: true
        continue-on-error: true

      - name: Upload Drift Report
        if: steps.plan.outputs.exitcode == '2'
        uses: actions/upload-artifact@v4
        with:
          name: drift-report-prod
          path: /tmp/drift-prod.txt
          retention-days: 30

      - name: Create Drift Summary
        run: |
          echo "### Drift Detection - Prod Environment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ steps.plan.outputs.exitcode }}" == "0" ]]; then
            echo "‚úÖ **No drift detected**" >> $GITHUB_STEP_SUMMARY
            echo "Infrastructure matches Terraform configuration." >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ steps.plan.outputs.exitcode }}" == "2" ]]; then
            echo "‚ö†Ô∏è **Drift detected!**" >> $GITHUB_STEP_SUMMARY
            echo "Infrastructure has diverged from Terraform configuration." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Action Required:** Review the drift report and take corrective action." >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Error occurred**" >> $GITHUB_STEP_SUMMARY
            echo "Failed to check for drift. Review logs for details." >> $GITHUB_STEP_SUMMARY
          fi

  # Create issue if drift detected
  create-drift-issue:
    name: Create Drift Issue
    needs: [detect-drift-dev, detect-drift-prod]
    if: |
      always() &&
      (needs.detect-drift-dev.outputs.drift_detected == '2' ||
       needs.detect-drift-prod.outputs.drift_detected == '2')
    runs-on: ubuntu-latest
    steps:
      - name: Create Drift Issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const devDrift = '${{ needs.detect-drift-dev.outputs.drift_detected }}' === '2';
            const prodDrift = '${{ needs.detect-drift-prod.outputs.drift_detected }}' === '2';

            let environments = [];
            if (devDrift) environments.push('**dev**');
            if (prodDrift) environments.push('**prod**');

            const envList = environments.join(' and ');

            const title = `‚ö†Ô∏è Infrastructure Drift Detected - ${environments.join(' & ')}`;
            const body = `### Infrastructure Drift Detected

            **Drift detected in:** ${envList}
            **Detected at:** ${new Date().toUTCString()}
            **Detection Run:** ${{ github.run_id }}

            ### What is Infrastructure Drift?
            Infrastructure drift occurs when the actual state of infrastructure
            diverges from the desired state defined in Terraform configuration.

            ### Environments Affected
            ${devDrift ? '- ‚ö†Ô∏è **Development**' : ''}
            ${prodDrift ? '- ‚ö†Ô∏è **Production**' : ''}

            ### Possible Causes
            - Manual changes made directly in Azure Portal
            - Changes made by other automation tools
            - Resources created/modified outside of Terraform
            - Configuration changes not committed to repository

            ### Action Required
            1. üì• Download drift report artifacts from [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            2. üîç Review changes that caused drift
            3. ü§î Determine if changes are intentional or accidental
            4. üîß Take corrective action:
               - **Option A:** Import changes into Terraform if intentional
               - **Option B:** Re-apply Terraform to revert unintended changes
               - **Option C:** Update Terraform config to match desired state

            ### How to Fix
            \`\`\`bash
            # For dev environment
            terraform plan -var-file=environments/dev/terraform.tfvars
            terraform apply -var-file=environments/dev/terraform.tfvars

            # For prod environment
            terraform plan -var-file=environments/prod/terraform.tfvars
            terraform apply -var-file=environments/prod/terraform.tfvars
            \`\`\`

            ### Prevention
            - Use Azure Policy to prevent manual changes
            - Enable resource locks on critical resources
            - Regular drift detection (already automated)
            - Educate team on using Terraform for all changes

            **Workflow URL:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            `;

            const labels = ['drift-detection', 'infrastructure'];
            if (devDrift) labels.push('dev');
            if (prodDrift) labels.push('prod');
            if (prodDrift) labels.push('P1-high');

            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: labels
            });
